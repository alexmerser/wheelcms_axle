{# base template that includes editing controls #}
{% extends "wheelcms_axle/base.html" %}

{% block javascript %}

{{ block.super }}

<script src="/static/js/upload/jquery.ui.widget.js"></script>
<script src="/static/js/upload/jquery.iframe-transport.js"></script>
<script src="/static/js/upload/jquery.fileupload.js"></script>

<script type="text/javascript" charset="utf-8">
    var current_path = '';
    
    function bt_stack_fix() {
        /*
         * https://github.com/twitter/bootstrap/issues/4781
         * http://stackoverflow.com/questions/13649459/twitter-bootstrap-multiple-modal-error
         */
        $(document).off('focusin.modal');

    }

    function fix_sizes() {
        /*
         * Make sure the "panels" div takes up exactly the remaining space.
         * Can this be done in css? XXX
         */
        var total = $("#browseModal .modal-body").height();
        var header = $("#browsecrumbs").height();
        var remainder = total - header;
        $("#panels").height(remainder);
    }
    function load_panels(path, panelid) {
            /*
             * How should the shifting of panels behave? Currently, if possible,
             * all three columns are used. This may mean that clicking in the first
             * colum will move the first panel to the second position. But this
             * doesn't have to be bad - it's a nice way to access the parent
             */
            current_path = path;
            var data = $.ajax({
                url: '/panel?path='+path,
                dataType:"json",
                async: false
                }).responseText;
            data = $.parseJSON(data);
            var panels = data.panels;
            var crumbs = data.crumbs;

            var path = data.path;

            var idx = 0;
            for(var i= 0; i < 3; i++) {
                $(".panel" + i).empty();
            }

            for(var i=0; i < panels.length; i++) {
                var paneldata = panels[i];
                var panel = $(".panel" + i);
                panel.html(paneldata);
            }
            $(".crumbcontainer").html(crumbs);
            fix_sizes();
    }

    function wheel_browser(path, callback) {
        $("#browseModal").modal();
        bt_stack_fix();
        load_panels(path || '', 3);

        $(".modal_select").click(function() {
            if(callback) {
                callback(current_path);
            }
            $("#browseModal").modal('hide');
        });
    }
    $(document).ready(function() {
        $("#show_modal").click(function(callback) {
            wheel_browser();
        });
        $("tr.entry").live('click', function() {
            var path = $(this).data('url');
            var panelid = parseInt($(this).parents("div.panel").data('panel'));
            load_panels(path, panelid);
            return false;
        });
        $("a.crumb").live('click', function() {
            var path = $(this).data('url');
            var panelid = parseInt($(this).parents("div.panel").data('panel'));
            load_panels(path, panelid);
            return false;
        });


        function load_form(url, type) {
            if(url == '/') {
                url = '';
            }
            var data = $.ajax({
                url: url + '/fileup?type=' + type,
                dataType:"json",
                async: false
                }).responseText;
            data = $.parseJSON(data);
            var form = data.form;
            $(".uploadform").html(form);

            $('#fileupload').fileupload({
                dataType: 'json',
                url: url + '/fileup',
                done: function (e, data) {
                    $("#uploadModal").modal("hide");
                    var path = data.result.path;
                    // should scroll to selection(s)!
                    load_panels(path, 3);
                // fail, .. http://api.jquery.com/Types/#Promise
                }
            });

        }
        $(".node_upload").live('click', function() {
            // hide & reopen browse dialog?
            var url = $(this).data('url');
            $("#uploadModal").modal();
            bt_stack_fix();
            load_form(url, $(".select_type").val());
            $(".select_type").change(function() {
                load_form(url, $(this).val());
            });
            return false;
        });
    });

</script>

{% endblock %}

{% block base_main %}

<!-- Button to trigger modal -->

<div id="browseModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="browseModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="browseModalLabel">Select a file</h3>
  </div>
  <div class="modal-body">
    <div class="row-fluid" id="browsecrumbs">
      <div class="row12 crumbcontainer">
      </div>
    </div>
    <div class="row-fluid" id="panels">
      <div class="span4 panel panel0" data-panel="0" id="panel0">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
      </div>
      <div class="span4 panel panel1" data-panel="1" id="panel1">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
      </div>
      <div class="span4 panel panel2" data-panel="2" id="panel2">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary modal_select">Select</button>
    <button class="btn btn-primary">Upload</button>
  </div>
</div>

<div id="uploadModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="uploadModalLabel">Upload a file</h3>
  </div>
  <div class="modal-body">
    <div class="row-fluid">
      <div class="span12">
        <select class="select_type">
          <option value="image">Upload an Image</option>
          <option value="file">Upload a File</option>
        </select>
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12 uploadform">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary modal_select">Select</button>
    <button class="btn btn-primary">Upload</button>
  </div>
</div>


{{ block.super }}

{% block base_main_edit %} {# block that automatically includes controls #} {% endblock %}
{% endblock %}
