{# base template that includes editing controls #}
{% extends "wheelcms_axle/base.html" %}

{% block javascript %}

{{ block.super }}

<script src="/static/js/upload/jquery.ui.widget.js"></script>
<script src="/static/js/upload/jquery.iframe-transport.js"></script>
<script src="/static/js/upload/jquery.fileupload.js"></script>

<script type="text/javascript" charset="utf-8">
    function bt_stack_fix() {
        /*
         * https://github.com/twitter/bootstrap/issues/4781
         * http://stackoverflow.com/questions/13649459/twitter-bootstrap-multiple-modal-error
         */
        $(document).off('focusin.modal');
    }

    var upload_modal = (function() {
        var mode = "any";
        var url = "";
        var callback = null;

        function load_form(url, type) {
            /*
             * Used by the upload modal: load the remote upload form, it can
             * be different depending on the context.
             */
            if(url == '/') {
                url = '';
            }
            var data = $.ajax({
                url: url + '/fileup?type=' + type,
                dataType:"json",
                async: false
                }).responseText;
            data = $.parseJSON(data);
            var form = data.form;
            $(".uploadform").html(form);

            $('#fileupload').fileupload({
                dataType: 'json',
                url: url + '/fileup',
                done: function (e, data) {
                    if(data.result.status == "ok") {
                      $("#uploadModal").modal("hide");

                      var path = data.result.path;
                      if(callback) {
                        callback(path);
                      }
                    }
                    else {
                        // if anything went wrong, it must have been with the uploaded file
                        $(".upload-alert").text(data.result.errors.storage);
                        $(".upload-alert").addClass("alert");
                    }
                // fail, .. http://api.jquery.com/Types/#Promise
                }
            });
        }

        return function(_url, _mode, _callback) {
            /*
             * Open the upload modal. url is where the content will be uploaded
             * to, mode determines what content can be uploaded:
             * - "any" means images and files
             * - "image" means only images
             */
            mode = _mode;
            url = _url;
            callback = _callback;

            var header = $("#uploadModalLabel");
            var types = $(".upload_types");

            /* XXX
             * The uploadable types should be much more dynamic - we may/will
             * eventually support different types of files and images from
             * which you can chose.
             */
            if(mode == "any") {
                header.text("Upload content");
                types.html('<select class="select_type"> ' +
                           '<option value="image">an Image</option> ' +
                           '<option value="file">a File</option> ' +
                           '</select>');
            } else {
                header.text("Upload an image");
                types.html('<select class="select_type"> ' +
                           '<option value="image">an Image</option> ' +
                           '</select>');
            }
            $("#uploadModal").modal();
            $(".upload-alert").empty();
            $(".upload-alert").removeClass("alert");
            bt_stack_fix();
            load_form(url, $(".select_type").val());
            $(".select_type").change(function() {
                load_form(url, $(this).val());
            });
            return false;
        }
    })();

    var wheel_browser = (function() {
        var modal;
        var current_path = '';
        var mode = "link";
        var callback = null;
        var initialized = false;
        var current_tab = "browse_local";


        function fix_sizes() {
            /*
             * Make sure the "panels" div takes up exactly the remaining space.
             * Can this be done in css? XXX
             */
            var total = $("#browseModal .modal-body").height();
            var header = $("#browsecrumbs").outerHeight(true);
            var tabs = $("#browseModal .nav-tabs").outerHeight(true);
            var remainder = total - header - tabs;
            $("#panels").height(remainder);

            var iframe = $("#external_iframe");

            // XXX -10 is a hack - iframe scrollbars?
            iframe.outerHeight(total-tabs-10);
            iframe.outerWidth(iframe.parent().innerWidth());

            $("#browse_external_image").height(total-tabs);

        }

        function modal_shown() {
            fix_sizes()
        }

        function load_panels(path, panelid) {
                /*
                 * How should the shifting of panels behave? Currently, if possible,
                 * all three columns are used. This may mean that clicking in the first
                 * colum will move the first panel to the second position. But this
                 * doesn't have to be bad - it's a nice way to access the parent
                 */
                current_path = path;
                var data = $.ajax({
                    url: '/panel?path='+encodeURIComponent(path) + "&mode="+mode,
                    dataType:"json",
                    async: false
                    }).responseText;
                data = $.parseJSON(data);
                var panels = data.panels;
                var crumbs = data.crumbs;

                var path = data.path;

                var idx = 0;
                for(var i= 0; i < 3; i++) {
                    $(".panel" + i).empty();
                }

                for(var i=0; i < panels.length; i++) {
                    var paneldata = panels[i];
                    var panel = $(".panel" + i);
                    panel.html(paneldata);
                }
                $(".crumbcontainer").html(crumbs);
                setTimeout(fix_sizes, 250);
                // find the current selection and see if it's selectable
                select_state($("tr[data-url='" + path + "']").data("selectable") == "yes");
        }

        function select_state(enabled) {
            /* enable/disable the 'Select' button */
            var selectbutton = $("#browseModal .modal_select");

            if(enabled) {
                selectbutton.removeAttr("disabled");
            }
            else {
                selectbutton.attr("disabled", "disabled");
            }
        }

        function tab_selected(e) {
            /*
             * A different tab has been selected. Check the select button state,
             * update the current_tab variable so we'll submit the right data
             */
            var target = e.target.href;
            var hash = target.substring(target.indexOf("#")+1);
            tab_selected = hash;
            select_state(false);
            if(tab_selected == "browse_local") {
                load_panels(current_path, 3);
            }
            else if(tab_selected == "browse_external_link") {
                //$("#external_title").val("");
                //$("#external_url").val("");
                //$("#external_target").val("");
                //$("#external_iframe").attr("src", "")
            }
            else if(tab_selected == "browse_external_image") {
                //$("#external_image_title").val("");
                //$("#external_image_url").val("");
                //$("#external_image").attr("src", "{{STATIC_URL}}/img/preview.png")
            }
            current_tab = tab_selected;
        }

        function handle_external_url_change(e) {
            // something changed in the url field. This may mean something valid has been entered.
            var url = $(this).val().replace(/^\s+|\s+$/g, '');
            select_state(url); // we'll accept any content as long as it's not empty 
        }
        function get_external_link() {
            // normalize link 
            var url = $("#external_url").val();
            url = url.replace(/^\s+|\s+$/g, '');
            if(url && url.indexOf("http") != 0) {
                 url = "http://" + url;
            }
            return url;
        }
        function get_external_image() {
            // normalize image
            var url = $("#external_image_url").val();
            url = url.replace(/^\s+|\s+$/g, '');
            if(url && url.indexOf("http") != 0) {
                 url = "http://" + url;
            }
            return url;
        }
        function init(_mode, _callback) {
            mode = _mode;
            callback = _callback;
            /*
             * Initialize handlers, set title
             */
            var header = $("#browseModalLabel");
            if(mode == "link") {
                header.text("Select content to link to");
            } else {
                header.text("Select an image to insert");
            }

            select_state(false);

            setTimeout(fix_sizes, 250);

            if(initialized) {
                return;
            }
            initialized = true;
            // stuff from here on only should be initialized once

            /*
             * stuff to do once the modal actually shows
             */
            modal.on('shown', modal_shown);
            /*
             * handle tab changes
             */
            modal.find('a[data-toggle="tab"]').on('shown', tab_selected);

            /*
             * Track changes on the external link input so we can
             * enable the <select> button
             */
            $("#external_url").bind('keyup input paste', handle_external_url_change);
            $("#external_image_url").bind('keyup input paste', handle_external_url_change);

            /*
             * The preview button will attempt to load the
             * url in an iframe
             */
            $("#external_url_preview").click(function() {
                var url = get_external_link();
                if(url) {
                    $("#external_iframe").attr("src", url);
                }
                return false;
            });
            /*
             * Same thing for image tab
             */
            $("#external_image_url_preview").click(function() {
                var url = get_external_image();
                if(url) {
                    $("#external_image").attr("src", url);
                }
                return false;
            });
            /*
             * Clicking the <select> button (if enabled) should insert the link.
             * This will depend on which tab is showing
             */
            $(".modal_select").click(function() {
                if(callback) {
                    var link = ""
                    var args = {}
                    if(current_tab == "browse_local") {
                        /*
                         * combine link/image mode. Worst case we'll fill in some properties
                         * as undefined that won't be used by that mode anyway
                         */
                        link = current_path;
                        args.title = $("#local_image_title").val();
                        args.target = $("#local_image_target").val();
                        args.size = $("input[type='radio'][name='local_image_size']:checked").val();
                    }
                    else if(current_tab == "browse_external_link") {
                        link = get_external_link();
                        args.title = $("#external_title").val();
                        args.target = $("#external_target").val();
                    }
                    else if(current_tab == "browse_external_image") {
                        link = get_external_image();
                        args.title = $("#external_image_title").val();
                        args.size = $("input[type='radio'][name='external_image_size']:checked").val();
                        console.log(args);
                    }
                    callback(link, args);
                }
                modal.modal('hide');
            });

            /*
             * cliking an entry in a panel should load the subpanel/content
             */
            $("tr.entry").live('click', function() {
                var path = $(this).data('url');
                var panelid = parseInt($(this).parents("div.panel").data('panel'));
                load_panels(path, panelid);
                if($(this).data("selectable") == "yes") {
                    select_state(true);
                }
                else {
                    select_state(false);
                }
                return false;
            });
            /*
             * clicking a path component in the breadcrumb should take you there
             */
            $("a.crumb").live('click', function() {
                var path = $(this).data('url');
                var panelid = parseInt($(this).parents("div.panel").data('panel'));
                load_panels(path, panelid);
                return false;
            });
            /*
             * clicking the upload icon should open the upload modal
             */
            $(".node_upload").live('click', function() {
                var url = $(this).data('url');
                // hide & reopen browse dialog?
                upload_modal(url, mode=="link"?"any":"image", function(path) {
                    // should scroll to selection(s)!
                    load_panels(path, 3);
                });
            });
        }

        function load_link(path, options) {
            /*
             * Load an existing link for updating
             */
            modal.find('a[href="#browse_external_link"]').tab('show');
            $("#external_url").val(path);
            if(options.title) {
                $("#external_title").val(options.title);
            }
            else {
                $("#external_title").val("");
            }
            if(options.target) {
                $("#external_target").val(options.target);
            }
            else {
                $("#external_target").val("");
            }
            if(path) {
                select_state(true);
            }
        }

        function load_image(path, options) {
            /*
             * Load an existing image for updating
             */
            modal.find('a[href="#browse_external_image"]').tab('show');
            $("#external_image_url").val(path);
            if(options.size) {
                $("input[type='radio'][name='external_image_size'][value='" + options.size + "']").attr("checked", "checked");
            }
            else {
                $("input[type='radio'][name='external_image_size'][value='original']").attr("checked", "checked");
            }
            if(options.title) {
                $("#external_image_title").val(options.title);
            }
            else {
                $("#external_image_title").val("");
            }
            if(path) {
                select_state(true);
            }
        }

        function load_local(path, options) {
            /*
             * Load content browser
             */
            modal.find('a[href="#browse_local"]').tab('show');
            load_panels(path || '', 3);
            // can be file or image!
            if(options.title) {
                $("#local_image_title").val(options.title);
            }
            if(options.target) {
                $("#local_image_target").val(options.target);
            }
            if(options.size) {
                $("input[type='radio'][name='local_image_size'][value='" + options.size + "']").attr("checked", "checked");
            }
            else {
                $("input[type='radio'][name='local_image_size'][value='original']").attr("checked", "checked");
            }
            // else use default: content title
        }

        return function(path, mode, options, callback) {
            modal = $("#browseModal");
            init(mode, callback);
            modal.modal();
            bt_stack_fix();
            // move to init?
            if(mode == "link") {
                // hide image
                $("#image_tab").hide()
                $("#link_tab").show()
            }
            else { // image
                // hide link
                $("#image_tab").show()
                $("#link_tab").hide()
            }
            if(path.indexOf('http') == 0) {
                if(mode == "link") {
                    load_link(path, options);
                } else {
                    load_image(path, options);
                }
            }
            else {
                load_local(path, options);
            }
        }
    })();

</script>

{% endblock %}

{% block base_main %}

<!-- Button to trigger modal -->

<div id="browseModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="browseModalLabel" aria-hidden="true">
  <div class="modal-body tabbable">
    <ul class="nav nav-tabs">
      <li id="local_tab" class="active"><a href="#browse_local" data-toggle="tab">Local / Browse</a></li>
      <li id="link_tab" class=""><a href="#browse_external_link" data-toggle="tab">External Link</a></li>
      <li id="image_tab" class=""><a href="#browse_external_image" data-toggle="tab">External Image</a></li>
      <li class="pull-right"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button></a>
    </ul>

    <div class="tab-content">
      <div id="browse_local" class="tab-pane active">
        <div class="row-fluid" id="browsecrumbs">
          <div class="row12 crumbcontainer">
          </div>
        </div>
        <div class="row-fluid" id="panels">
          <div class="span4 panel panel0" data-panel="0" id="panel0">
          </div>
          <div class="span4 panel panel1" data-panel="1" id="panel1">
          </div>
          <div class="span4 panel panel2" data-panel="2" id="panel2">
          </div>
        </div>
      </div>
      <div id="browse_external_link" class="tab-pane">
        <div class="row-fluid">
          <div class="span6">
            <form>
              <legend>External URL</legend>
              <label class="control-label" for="external_title">Link title</label>
              <input id="external_title" type="text" name="title" maxlength="256" />
              <label class="control-label" for="external_url">URL</label>
              <div class="input-append">
                <input id="external_url" type="text" name="url" maxlength="256" />
                <button id="external_url_preview" class="btn">Preview <i class="icon-chevron-right"></i></button>
              </div>
              <label class="control-label" for="external_target">Link target</label>
              <input id="external_target" type="text" name="target" maxlength="256" />
            </form>
          </div>
          <div class="span6">
            <iframe width="90%" id="external_iframe" src=""></iframe>
          </div>
        </div>
      </div>
      <div id="browse_external_image" class="tab-pane">
        <div class="row-fluid">
          <div class="span6">
            <form>
              <legend>External Image</legend>
              <label class="control-label" for="external_image_title">Image title</label>
              <input id="external_image_title" type="text" name="title" maxlength="256" />
              <label class="control-label" for="external_image_url">URL</label>
              <div class="input-append">
                <input id="external_image_url" type="text" name="url" maxlength="256" />
                <button id="external_image_url_preview" class="btn">Preview <i class="icon-chevron-right"></i></button>
              </div>
              <label class="control-label" for="image_size">Size</label>
              <div class="controls" id="image_size">
                {# XXX make this dynamic / centrally defined #}
                <label class="checkbox">
                  <input type="radio" name="external_image_size" value="img_content_original"> Original
                </label>
                <label class="checkbox">
                  <input type="radio" name="external_image_size" value="img_content_thumb"> Thumb
                </label>
                <label class="checkbox">
                  <input type="radio" name="external_image_size" value="img_content_small"> Small
                </label>
                <label class="checkbox">
                  <input type="radio" name="external_image_size" value="img_content_medium"> Medium
                </label>
                <label class="checkbox">
                  <input type="radio" name="external_image_size" value="img_content_large"> Large
                </label>
              </div>
            </form>
          </div>
          <div class="span6">
            <img id="external_image" src="{{STATIC_URL}}/img/preview.png" class="img-polaroid">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary modal_select">Select</button>
  </div>
</div>

<div id="uploadModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="uploadModalLabel">Upload a file</h3>
  </div>
  <div class="modal-body">
    <div class="row-fluid">
      <div class="span12 upload-alert">
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12 form-horizontal">
        <div class="control-group">
          <label class="control-label" for="select_type">Upload</label>
          <div class="controls upload_types">
          </div>
        </div>
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12 uploadform">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary modal_select">Select</button>
  </div>
</div>


{{ block.super }}

{% block base_main_edit %} {# block that automatically includes controls #} {% endblock %}
{% endblock %}
